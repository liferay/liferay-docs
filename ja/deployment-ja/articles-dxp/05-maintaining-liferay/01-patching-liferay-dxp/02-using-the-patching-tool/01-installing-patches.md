# パッチのインストール[](id=installing-patches)

パッチをインストールする前に、サーバーをシャットダウンする必要があります。Windowsオペレーティングシステムでは、使用中のファイルはOSによってロックされているため、パッチを適用できません。Unixスタイルのシステムでは、通常、実行中のファイルを置き換えることができますが、古いファイルはメモリ内にあります。これらの理由から、パッチをインストールする前に@ product @をシャットダウンするのがベストです。



Liferayは、すべてのパッチ（フィックスパックとホットフィックス）をZIPファイルとして配布しています。LESAチケット（ホットフィックス）または[Customer Portal](https://web.liferay.com/group/customer)（フィックスパック）からパッチをダウンロードする時は、解凍せずにパッチングツールの`patches`フォルダ（たとえば`[Liferay Home]/patching-tool/patches`）に配置します。インストールされているパッチと利用可能なローカルパッチを一覧表示するには、次のコマンドを実行します：

    patching-tool info

これにより、すでにインストールされているパッチの一覧と、パッチ`フォルダ`内のものからインストール*できる*パッチの一覧が表示されます。



利用可能なパッチをインストールするには、次の手順に従います。まず、以下のコマンドを発行します。

    patching-tool install

変更されたすべてのOSGiバンドルが既存のバンドルを置き換えるようにするには、[Liferay Home](/discover/deployment/-/knowledge_base/7-1/installing-liferay#liferay-home)フォルダーから`osgi/state`フォルダーを 削除してください。

+$$$

**注**：`osgi/state`フォルダーにはOSGiバンドルの状態情報が含まれています。ホットフィックスまたはフィックスパックでのOSGiバンドルの変更が内部的なものである場合、OSGiフレームワークからは見えません。よって、OSGiバンドルはインストールされたままで、その状態情報は変わりません。たとえば、ホットフィックスの場合、APIを使わないインプレースチェンジが含まれることがあります。フレームワークはそのような変更を検出できません。
フィックスパックの変更はフレームワークに対して透過的な場合があります。これらの理由から、フィックスパックおよびホットフィックスの適用後に`osgi/state`フォルダーを削除することをおすすめします。



$$$

+$$$

** 重要：**`osgi/state`フォルダーは、開発環境で作業しているか、フィックスパック・ホットフィックスを適用している場合のみ削除してください。



$$$

パッチによって作成された新しいデータベースインデックスがある場合、パッチングツールはそれらを更新するように指示します。リストを取得するには、次のコマンドを実行してください：


    patching-tool index-info

パッチ適用時にはデータベース接続がないため、インデックスはポータルの立ち上げ時に作成する必要があります。サーバーにデータベースインデックスを変更する権限がある場合は、@ product @に起動時に自動的にインデックスを作成するように以下を`portal-ext.properties`ファイルに追加することを指示します：

    database.indexes.update.on.startup=true

それ以外の場合は、インデックスをマニュアルで作成する必要があります。詳細は、`patching-tool index-info`コマンド出力を確認してください。



パッチをインストールしたら、`patching-tool info`コマンドを実行して確認できます。



+$$$

** 注：**インストールされたパッチに問題がある場合、以前のフィックスパックのパッチインストールからの残りのファイルがないこと、またはアプリケーションサーバーキャッシュ内にホットフィックスがないことを確認してください。



$$$

インストール中、`patching-backup-deps.zip`および`patching-backup.zip`ファイルが作成され、Webアプリケーションの`WEB-INF`フォルダ内に保存されます。これらのファイルは、@ product @の元の状態を復元するために必要です。それらを削除すると、パッチ適用は無効になります。

+$$$

**注意：**パッチをインストールするとき、@ product @の`web.xml`は常にパッチに含まれているものに上書きされます。`web.xml`をカスタマイズした場合は、パッチをインストールした後にカスタマイゼーションを再実行しなければなりません。



$$$

`patching-backup.zip`ファイルはまた次回パッチをインストールするために必要です。なぜなら、パッチングツールは新しいパッチをインストールする前にインストールされたフィックスパックを元に戻すからです。インストール済みのフィックスパックを元に戻すには、`patching-backup.zip`の内容を調べ、 元に戻すために必要な変更を判別します。

## ホットフィックスとパッチの処理[](id=handling-hot-fixes-and-patches)

前述のように、ホットフィックスは迅速に提供される短期間の修正であり、フィックスパックは定期的にすべての顧客に提供される大きなバンドルの修正です。すでにホットフィックスがインストールされており、そのホットフィックスを含むフィックスパックがリリースされている場合は、パッチ適用ツールがそれを管理できます。フィックスパックは常にホットフィックスよりも優先されます。そのため、フィックスパックをインストールすると、それに含まれているホットフィックスがアンインストールされ、その場所にフィックスパックのバージョンがインストールされます。



パッチングツールは、フィックスパックに自動的に修正を適用します。フィックスパックの新規（固定）バージョンがリリースされている場合は、パッチングツールを使用してそれをインストールしてください。パッチングツールは、古いフィックスパックをアンインストールし、その代わりに新しいバージョンをインストールします。

## フィックスパックの依存関係[](id=fix-pack-dependencies)

一部のホットフィックスはフィックスパックに依存しています。フィックスパックに依存しているホットフィックスをインストールしようとすると、パッチングツールから通知がきます。[Customer Portal](https://web.liferay.com/group/customer/dxp/downloads/7-1)に移動して 、ホットフィックスの依存関係を取得します。必要なパッチがすべて`patches`フォルダに入ったら、パッチングツールはそれらをインストールします。

## パッチングツールの更新[](id=updating-the-patching-tool)

インストールしようとしているパッチにパッチングツールのアップデートが必要な場合は、パッチングツールから通知されます。パッチングツールを更新するには、最新のものを[Customer Portal](https://web.liferay.com/group/customer/dxp/downloads/7-1/patching-tool)からダウンロードしてください。
新しいものを`patching-tool`フォルダの親フォルダに解凍して、既存のパッチングツールに上書きします。

## クリーンアップ[](id=cleaning-up)

パッチ適用手順を実行した後（パッチをインストールまたは削除（[removed patches](/discover/deployment/-/knowledge_base/7-1/working-with-patches#uninstalling-patches)）したかにかかわらず ）、@ product @のデプロイ済みコードのキャッシュをクリーンアップすることが重要です。これをすることにより、サーバーを起動したときにインストールしたばかりのパッチを使用していることを確認できます。この手順はいたって簡単です。

キャッシュされたコードを消去するには、`[Liferay Home]/work` フォルダの内容を削除します。これでサーバーを起動することができます。
